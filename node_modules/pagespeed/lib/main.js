function pagespeed ( ) {
};

module.exports = pagespeed;

pagespeed.js_to_bottom = function ( output ) {
  return pagespeed.move_tags( output, /(<\!.*?>\s*)?<script(?! data="(head|inline)")[\s\S]*?script>(\s*<\!.*?>)?/ig, /(<\/body.*)/i );
}

pagespeed.css_to_head = function ( output ) {
  return pagespeed.move_tags( output, /(<\!.*?>\s*)?(<link[^>]+href=[^>]+(\.css)[^>]+>|<style[\s\S]*?style>)(\s*<\!.*?>)?/ig, /(<\/head.*)/i );
}

pagespeed.move_tags = function ( output, match_tags, match_destination ) {
  if ( ! match_destination.test( output )) return output;
  if ( ! ( output && output.replace )) return output;
  var tags = [], tag;
  while ( tag = match_tags.exec( output )) {
    tags.push( tag[0] );
  }
  return output.replace( match_tags, '').replace( match_destination, function( str, destination ) {
    return tags.join('') + destination;
  } );
}

pagespeed.strip = function ( output ) {
  if ( ! ( output && output.replace )) return output;
  return output.replace( />\s*?</g, '><' );
}

pagespeed.middleware = function ( options ) {
  options = options || { };
  return function ( req, res, next ) {
    var send = res.send; 
    res.send = function ( output ) {
      if ( ! options.no_js_to_bottom ) {
        output = pagespeed.js_to_bottom( output );
      }
      if ( ! options.no_css_to_head ) {
        output = pagespeed.css_to_head( output );
      }
      if ( ! options.no_strip ) {
        output = pagespeed.strip( output );
      }
      res.send = send;
      res.send( output );
    };
    next( );
  };
}
